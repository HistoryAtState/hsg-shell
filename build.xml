<?xml version="1.0" encoding="UTF-8"?>
<project default="xar" name="hsg-shell">
    <xmlproperty file="build.properties.local.xml" semanticAttributes="true" keepRoot="false"/>
    <xmlproperty file="build.properties.xml" semanticAttributes="true" keepRoot="false"/>
    <xmlproperty file="expath-pkg.xml"/>
    <property name="build.dir" value="build"/>
    <property environment="env"/>

    <!-- Allow NODE_ENV to be passed in either as an environment variable or as a regular variable -->
    <condition property="node-env-is-set-for-production" else="false">
        <or>
            <equals arg1="${env.NODE_ENV}" arg2="production"/>
            <equals arg1="${NODE_ENV}" arg2="production"/>
        </or>
    </condition>

    <!-- Create a new property that sets production mode based on whether either variation of NODE_ENV is set to production -->
    <condition property="NODE_ENV.production" value="production">
        <istrue value="${node-env-is-set-for-production}"/>
    </condition>

    <!-- Check if git file is present -->
    <available file=".git" type="dir" property="git.present"/>

    <!-- Retrieve current git HEAD hash -->
    <target name="git.revision" description="Store git revision in ${repository.version}" if="git.present">
        <exec executable="git" outputproperty="git.revision" failifexecutionfails="false" errorproperty="">
            <arg value="describe"/>
            <arg value="--tags"/>
            <arg value="--always"/>
            <arg value="HEAD"/>
        </exec>
        <condition property="repository.version" value="${git.revision}" else="unknown">
            <and>
                <isset property="git.revision"/>
                <length string="${git.revision}" trim="yes" length="0" when="greater"/>
            </and>
        </condition>
        <echo message="git HEAD is at ${repository.version}"/>
    </target>

    <!-- Retrieve current git branch -->
    <target name="git.branch" description="Store git branch in ${repository.branch}" if="git.present">
        <exec executable="git" outputproperty="git.branch" failifexecutionfails="false" errorproperty="">
            <arg line="rev-parse --abbrev-ref HEAD"/>
        </exec>
        <echo message="Current branch: ${git.branch}"/>
    </target>

    <target name="clean">
        <echo message="Deleting xar files..."/>
        <delete>
            <fileset dir="${build.dir}"/>
        </delete>
        <mkdir dir="${build.dir}"/>
    </target>

    <target name="copy" depends="git.branch,git.revision" >
        <copy todir="${build.dir}/${app.name}-${app.version}-${git.branch}-${git.revision}">
            <fileset dir="${basedir}"
                     excludes="${build.dir}/** node_modules/** bower-components/** package.json gulpfile.js .editorconfig .* *.properties expath-pkg.xml.tmpl repo.xml.tmpl"/>
        </copy>
        <antcall target="apply-filters"/>
    </target>

    <target name="apply-filters">
        <copy todir="${build.dir}/${app.name}-${app.version}-${git.branch}-${git.revision}" overwrite="true" verbose="true">
            <fileset file="expath-pkg.xml.tmpl"/>
            <fileset file="repo.xml.tmpl"/>
            <filterset>
                <filter token="name" value="${app.name}"/>
                <filter token="version" value="${app.version}"/>
                <filter token="url" value="${app.url}"/>
                <filter token="description" value="${app.description}"/>
                <filter token="website" value="${app.website}"/>
                <filter token="status" value="${app.status}"/>
                <filter token="permissions" value="${app.permissions}"/>
            </filterset>
            <globmapper from="*.tmpl" to="*"/>
        </copy>
    </target>

    <target name="xar" depends="clean, copy, git.branch, git.revision" description="main target to create application XAR file">
        <echo message="Calling npm start... (Production? ${node-env-is-set-for-production})"/>
        <exec executable="${npm}" outputproperty="npm.output">
            <arg line="start"/>
            <env key="PATH" value="${env.PATH}:${node.PATH}"/>
            <env key="NODE_ENV" value="${NODE_ENV.production}"/>
        </exec>
        <echo message="${npm.output}"/>
        <antcall target="apply-filters"/>
        <zip basedir="${build.dir}/${app.name}-${app.version}-${git.branch}-${git.revision}"
             destfile="${build.dir}/${app.name}-${app.version}-${git.branch}-${git.revision}.xar"
             excludes="${build.dir}/** node_modules/** package.json gulpfile.js .editorconfig .* *.properties expath-pkg.xml.tmpl repo.xml.tmpl"/>
        <echo message="Deleting build files..."/>
        <delete dir="${build.dir}/${app.name}-${app.version}-${git.branch}-${git.revision}" excludes="/${app.name}-${app.version}-${git.branch}-${git.revision}.xar"/>
    </target>

    <target name="gulp-clean">
        <echo message="Calling gulp clean..."/>
        <exec executable="${gulp}" outputproperty="gulp.output">
            <arg line="clean"/>
            <env key="PATH" value="${env.PATH}:${node.PATH}"/>
        </exec>
        <echo message="${gulp.output}"/>
        <echo message="Deleting xar files..."/>
        <delete>
            <fileset dir="${build.dir}">
                <include name="*.xar"/>
            </fileset>
        </delete>
    </target>
</project>
